function MusicVisualizer(t){this.source=null,this.count=0,this.analyser=this.audioCtx.createAnalyser(),this.size=t.size,this.analyser.fftSize=2*this.size,this.gainNode=this.audioCtx[this.audioCtx.createGain?"createGain":"createGainNode"](),this.gainNode.connect(this.audioCtx.destination),this.analyser.connect(this.gainNode),this.xhr=new XMLHttpRequest,this.visualizer=t.visualizer,this.visualize()}MusicVisualizer.prototype={audioCtx:new(window.AudioContext||window.webkitAudioContext),load:function(t,i){var e=this;this.xhr.abort(),this.xhr.open("GET",t),this.xhr.responseType="arraybuffer",this.xhr.onload=function(){i(e.xhr.response)},this.xhr.send()},decode:function(t,i){this.audioCtx.decodeAudioData(t,function(t){i(t)},function(t){console.error(t)})},play:function(t,i){var e=this,n=++this.count;this.source&&this.stop(),this.load(t,function(t){e.decode(t,function(t){if(n==e.count){var o=e.audioCtx.createBufferSource();o.loop=!0,o.connect(e.analyser),o.buffer=t,e.source=o,i&&i()}})})},start:function(){this.source[this.source.start?"start":"noteOn"](0)},stop:function(){this.source[this.source.stop?"stop":"noteOff"](0)},changeVolume:function(t){this.gainNode.gain.value=t*t},visualize:function(){function t(){e.analyser.getByteFrequencyData(i),e.visualizer(i),requestAnimationFrame(t)}var i=new Uint8Array(this.analyser.frequencyBinCount);requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame;var e=this;requestAnimationFrame(t)},slow:function(){this.source.playbackRate.value=.5}};